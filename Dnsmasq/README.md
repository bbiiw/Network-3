# Dnsmasq
## บทบาทหรือหน้าที่บน Linux
Dnsmasq เป็นโปรแกรมบริการ `DNS (Domain Name System)` และ `DHCP (Dynamic Host Configuration Protocol)` ที่มักถูกใช้บนระบบปฏิบัติการ Linux เพื่อให้บริการและจัดการเครือข่ายได้อย่างมีประสิทธิภาพ บางครั้ง Dnsmasq ยังใช้งานเป็นหน่วยควบคุมการเข้าถึงอินเทอร์เน็ต (Internet Access Control) และการกรองเนื้อหา (Content Filtering) ด้วย

1. **บริการ DNS**: Dnsmasq ทำหน้าที่เป็นเซิร์ฟเวอร์ DNS โดยสามารถแปลงชื่อโดเมน (Domain Name) เป็นที่อยู่ IP (IP Address) และนำเสนอข้อมูล DNS อื่นๆ เช่น MX Records, CNAME Records และอื่นๆ ให้กับผู้ใช้งานในเครือข่าย

2. **บริการ DHCP**: Dnsmasq สามารถให้บริการ DHCP โดยจะจัดการกำหนดที่อยู่ IP และคอนฟิกเราเตอร์และอุปกรณ์เครือข่ายอื่นๆ ในเครือข่าย

3. **การบริหารจัดการที่อยู่ IP**: Dnsmasq สามารถจัดการการตั้งค่าที่อยู่ IP สำหรับอุปกรณ์ในเครือข่ายได้อย่างมีประสิทธิภาพ รวมถึงการสร้างส่วนเชื่อมต่อสำหรับเครือข่ายส่วนตัว (Virtual Private Networks)

4. **การบันทึกการเชื่อมต่อและกิจกรรม**: Dnsmasq มักจะบันทึกการเชื่อมต่อและกิจกรรมของผู้ใช้งานในเครือข่าย ที่จะช่วยในการตรวจสอบและการวิเคราะห์ปัญหาที่เกิดขึ้นในเครือข่าย

5. **การกรองเนื้อหา**: Dnsmasq สามารถใช้งานเป็นเครื่องกรองเนื้อหา (Content Filter) โดยสามารถกำหนดเงื่อนไขในการเข้าถึงเว็บไซต์และการกรอง URL ตามนโยบายขององค์กรหรือเครือข่าย

6. **การรวมการสร้างเครือข่าย (Network Booting)**: Dnsmasq สามารถใช้ในการรวมการสร้างเครือข่าย (Network Booting) เพื่อติดตั้งระบบปฏิบัติการผ่านทางเครือข่ายและการดาวน์โหลดไฟล์ต่างๆ จากเซิร์ฟเวอร์ในเครือข่าย


## พื้นฐานหรือหลักการทำงานของ Dnsmasq

1. **การรับคำขอ DNS (DNS Request Reception)**:
เมื่อ Dnsmasq ได้รับคำขอ DNS จากเครื่องลูกข่าย (client) ผ่านพอร์ต 53 หรือตามการกำหนดค่าที่กำหนดไว้ เครื่อง Dnsmasq จะเริ่มการทำงานด้วยการตรวจสอบคำขอ DNS นี้

2. **การตรวจสอบแคช (Cache Lookup)**:
Dnsmasq จะตรวจสอบในแคชเพื่อดูว่ามีข้อมูล DNS ที่ตรงกับคำขอนี้อยู่ในแคชหรือไม่ ถ้ามี Dnsmasq จะส่งคำตอบกลับไปทันทีโดยไม่ต้องส่งคำขอไปยังเซิร์ฟเวอร์ DNS ภายนอก

3. **การค้นหาในไฟล์ hosts (Hosts File Lookup)**:
หากไม่พบข้อมูลในแคช Dnsmasq จะตรวจสอบไฟล์ hosts (/etc/hosts) เพื่อหาข้อมูลที่ตรงกับคำขอ DNS ที่เข้ามา

4. **การส่งคำขอ DNS ไปยังเซิร์ฟเวอร์ DNS ภายนอก (Forwarding)**:
หากข้อมูล DNS ไม่อยู่ในแคชและไม่มีในไฟล์ hosts Dnsmasq จะส่งคำขอ DNS ไปยังเซิร์ฟเวอร์ DNS ภายนอก ที่ได้กำหนดไว้ในการกำหนดค่าของ Dnsmasq

5. **การจัดการคำขอ DHCP (DHCP Request Handling)**:
Dnsmasq ยังสามารถรับและจัดการคำขอ DHCP จากอุปกรณ์ในเครือข่าย เพื่อจัดการการกระจายที่อยู่ IP, ชื่อโดเมน และการกำหนดการสนับสนุนคอนฟิกให้กับอุปกรณ์ในเครือข่าย

6. **การบันทึกและการบริหารจัดการ (Logging and Management)**:
Dnsmasq สามารถบันทึกกิจกรรมการทำงาน และการจัดการคำขอ DNS และ DHCP เพื่อเพิ่มความสามารถในการตรวจสอบและการวิเคราะห์ปัญหาที่เกิดขึ้นในเครือข่าย

## การเรียกใช้งานและผลลัพธ์ที่ได้
### วิธีติดตั้งและกำหนดค่า Dnsmasq

เริ่มต้นด้วยการอัพเดตที่เก็บ

![](/image/dns1.png)

ปิดใช้งาน `systemd-resolved` โดยใช้คำสั่งด้านล่าง

![](/image/dns2.png)

ลบไฟล์คอนฟิกูเรชันสำหรับ `systemd-resolved` ใช้คำสั่ง

![](/image/dns3.png)

เมื่อนำการกำหนดค่าออกแล้ว ต้องสร้างใหม่และเพิ่ม Google DNS

![](/image/dns4.png)
![](/image/dns5.png)

เมื่อมีไฟล์การกำหนดค่าใหม่แล้ว ก็สามารถติดตั้ง Dnsmasq โดยใช้คำสั่งด้านล่าง เริ่มต้นด้วยการอัพเดทระบบ

![](/image/dns6.png)
![](/image/dns7.png)

ต่อไปคือการแก้ไขไฟล์กำหนดค่า Dnsmasq ต้องเปิดโดยใช้ตัวแก้ไขเช่น vim หรือ vi ตามที่แสดงด้านล่าง

![](/image/dns8.png)

เมื่อเปิดไฟล์แล้ว ให้ดำเนินการต่อและแก้ไขการกำหนดค่า

![](/image/dns9.png)

บรรทัดส่วนใหญ่จะแสดงความคิดเห็นพร้อมคำอธิบายว่าแต่ละบรรทัดทำหน้าที่อะไร 
ต้องยกเลิกการแสดงความคิดเห็นบางบรรทัดเหล่านี้

ต่อไปนี้เป็นข้อมูลสรุปโดยย่อเกี่ยวกับสิ่งที่จะไม่แสดงความคิดเห็น

![](/image/dns10.png)

ตั้งค่าโดเมนที่จะใช้โดย Dnsmasq ที่อยู่การฟัง และตั้งค่าขนาดแคชตามที่ระบุด้านบน ในขณะที่เปลี่ยนชื่อและ IP ให้ตรงกับของตัวเอง สุดท้าย บันทึกและปิดไฟล์โดยตรวจสอบทุกอย่าง

สิ่งเหล่านี้ไม่ใช่การกำหนดค่าเพียงอย่างเดียวที่สามารถทำได้ หากเห็นสิ่งที่เกี่ยวข้อง ให้กำหนดค่า และเมื่อเสร็จแล้ว ให้รีสตาร์ท Dnsmasq

![](/image/dns11.png)
![](/image/dns12.png)

ในไฟล์การกำหนดค่าเดียวกันที่เราเพิ่ม Google DNS เราจำเป็นต้องเพิ่มที่อยู่ IP Dnsmasq ที่อยู่ IP จะขึ้นอยู่กับเครือข่ายของตัวเอง และในกรณีของเรา เราใช้ที่อยู่ IP คลาส C 192.168.0.2

เปิดตัวแก้ไขนาโนและเพิ่มบรรทัดด้านล่าง

![](/image/dns13.png)
![](/image/dns14.png)
![](/image/dns15.png)

เพิ่ม DNS ในเครื่องไปยังเซิร์ฟเวอร์ Dnsmasq ด้วยการสร้างรายการในไฟล์ `/etc/hosts`

![](/image/dns27.png)

DNS ที่เพิ่มจะรับผิดชอบในการตอบคำถามของลูกค้า ในภาพด้านล่าง เราได้เพิ่มสอง DNS

![](/image/dns16.png)

เริ่มบริการ Dnsmasq ใหม่เพื่อรับการอัปเดต

![](/image/dns17.png)

ตรวจสอบการกำหนดค่าโดยเรียกใช้คำสั่งทดสอบด้านล่าง

![](/image/dns18.png)

ส่งคืนสถานะ OK เพื่อยืนยันว่าทุกอย่างทำงานได้

![](/image/dns19.png)


## การทดสอบ Dnsmasq DNS
DNS ที่กำหนดค่าไว้สามารถทดสอบได้โดยใช้คำสั่ง dig ซึ่งจะส่งคืนข้อมูล DNS หากมีอยู่ 
ตัวอย่างเช่น ลองใช้ `server1.com` คำสั่งจะเป็น

![](/image/dns20.png)
![](/image/dns21.png)

แทนที่ `server1.com` ด้วย DNS ที่สร้างขึ้น
ในภาพด้านล่าง จะส่งคืนคำตอบหมายความว่าทุกอย่างปกติดี
ยังสามารถตรวจสอบการแก้ปัญหา DNS ในเครื่องเพื่อให้แน่ใจว่า DNS ได้รับการตอบสนอง

![](/image/dns22.png)

ส่งคืน IP ของเซิร์ฟเวอร์

## ยืนยันการแคชเซิร์ฟเวอร์ DNS
ใช้คำสั่ง เจาะ Linux เพื่อตรวจสอบและยืนยันการแคช หากการแคชใช้งานได้ ควรสังเกตว่าเวลาที่ใช้ในการสืบค้น DNS ลดลง

สอบถามครั้งแรก

![](/image/dns23.png)

ครั้งที่สองควรส่งคืนเวลาสืบค้นที่สั้นกว่าเพื่อพิสูจน์ว่าการแคชทำงานอยู่

![](/image/dns24.png)
![](/image/dns25.png)

## ช่องโหว่ของ Dnsmasq

นักวิจัยรายงานช่องโหว่ใน Dnsmasq ทำให้ยิง DNS ปลอมได้ง่าย
บริษัทความปลอดภัยไซเบอร์จากอิสราเอล JSOF รายงานถึงชุดช่องโหว่ของโปรแกรม Dnsmasq ที่ใช้งานกันเป็นวงกว้างในเราท์เตอร์และอุปกรณ์เน็ตเวิร์คขนาดเล็ก 

- โดยช่องโหว่มีตั้งแต่ buffer overflow ที่อาจทำให้แฮกเกอร์ยึดอุปกรณ์ได้ ไปจนถึงช่องโหว่การยืนยันที่มาของ DNS ไม่ดีพอทำให้แฮกเกอร์ปลอมแปลงค่า DNS ได้ง่ายขึ้น โดยทาง JSOF เรียกชุดช่องโหว่นี้ว่า DNSpooq โดยแยกเป็นช่องโหว่ได้อีกสองชุด

   - ช่องโหว่ชุดแรก ได้แก่ CVE-2020-25681, CVE-2020-25682, CVE-2020-25683, และ CVE-2020-25687 เป็นช่องโหว่ buffer overflow เมื่อใช้งาน DNSSEC ทำให้แฮกเกอร์อาจยิง Dnsmasq ให้แคชได้

   - ช่องโหว่ชุดต่อมา ได้แก่ CVE-2020-25684, CVE-2020-25685, และ CVE-2020-25686 เป็นช่องโหว่การตรวจสอบต้นทาง DNS ที่ไม่หนาแน่นพอ ทำให้แฮกเกอร์สามารถเดาค่าพารามิเตอร์ต่างๆ เช่น หมายเลขพอร์ต และค่า TXID เพื่อยิงค่า DNS เข้า Dnsmasq ได้ 

โดยรวมแล้วค่าที่แฮกเกอร์ต้องคาดเดามีความยุ่งเหยิงระดับ 19 บิต (ต้องยิง DNS ประมาณห้าแสนครั้ง) จากที่ควรจะเป็น 32 บิต (สี่พันล้านครั้ง)
ทาง Dnsmasq แก้ช่องโหว่ทั้งหมดแล้วในเวอร์ชั่น 2.83 แต่ความยากของช่องโหว่เหล่านี้คือ Dnsmasq มักฝังไปกับเฟิร์มแวร์อุปกรณ์ต่างๆ ผู้ใช้ทั่วไปคงต้องรอผู้ผลิตอุปกรณ์ให้อัพเดตเฟิร์มแวร์ให้อีกครั้ง

![](/image/dns26.png)

## 📚 Reference

- https://th.linux-console.net/?p=14683
- https://www.blognone.com/node/120710
- https://chat.openai.com/c/67c9deab-9fef-4dd2-b6fb-a851cd4ceb2a

